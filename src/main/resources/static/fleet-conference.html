<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta content="width=device-width, initial-scale=1" name="viewport">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>参与者查看会议</title>
        <!-- Common plugins -->
        <script src="js/jquery.min.js"></script>
        <link href="会务管理系统样式1/css/bootstrap.min.css" rel="stylesheet">
        <link href="会务管理系统样式1/css/simple-line-icons.css" rel="stylesheet">
        <link href="会务管理系统样式1/css/font-awesome.min.css" rel="stylesheet">
        <link href="会务管理系统样式1/css/pace.css" rel="stylesheet">
        <link href="会务管理系统样式1/css/jasny-bootstrap.min.css" rel="stylesheet">
        <link href="css/nanoscroller.css" rel="会务管理系统样式1/stylesheet">
        <link href="css/metismenu.min.css" rel="会务管理系统样式1/stylesheet">
        <link href="会务管理系统样式1/css/c3.min.css" rel="stylesheet">
        <link href="会务管理系统样式1/css/blue.css" rel="stylesheet">
        <!-- dataTables -->
        <link href="会务管理系统样式1/css/jquery.datatables.min.css" rel="stylesheet" type="text/css">
        <link href="会务管理系统样式1/css/responsive.bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="会务管理系统样式1/css/jquery.toast.min.css" rel="stylesheet">
        <!--template css-->
        <link href="会务管理系统样式1/css/style.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->

        <script src="会务管理系统样式1/js/html5shiv.min.js"></script>
        <script src="会务管理系统样式1/js/respond.min.js"></script>

        <link href="会务管理系统样式1/fonts/iconfont.css" rel="stylesheet">
        <link href="assets/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/css/simple-line-icons.css" rel="stylesheet">
        <link href="assets/css/font-awesome.min.css" rel="stylesheet">
        <link href="assets/css/pace.css" rel="stylesheet">
        <link href="assets/css/jasny-bootstrap.min.css" rel="stylesheet">
        <link href="assets/css/nanoscroller.css" rel="stylesheet">
        <link href="assets/css/metismenu.min.css" rel="stylesheet">
        <link href="assets/css/c3.min.css" rel="stylesheet">
        <link href="assets/css/blue.css" rel="stylesheet">
        <!-- dataTables -->
        <link href="css/jquery.datatables.min.css" rel="stylesheet" type="text/css">
        <link href="css/responsive.bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="css/jquery.toast.min.css" rel="stylesheet">
        <!--template css-->
        <link href="css/style.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="js/html5shiv.min.js"></script>
        <script src="js/respond.min.js"></script>
        <style type="text/css">
            * {
                margin: 0px;
                padding: 0px;
            }

            .container a .items {
                border: 1px solid #eeeeee;
                /* padding: 5px; */
                margin-bottom: 50px;
                background-color: #ffffff;
                box-shadow: 0px 0 16px rgba(0, 0, 0, 0.2);
            }

            .container a .items p {
                color: #6f6f6f;
                padding: 0px 10px;
                margin: 0px;
            }

            .container a .items h4 {
                padding: 0px 10px;
                margin-top: 10px;
                color: #666666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .container a:hover div {
                transform: scale(1.15);
                transition: all .65s;
                overflow: hidden;
            }

            .container a:hover h4 {
                color: #00a0e9;
            }

            .container a p span {
                color: #d7d7d7;
            }

            .back-to-top {
                position: fixed;
                display: none;
                width: 40px;
                height: 40px;
                border-radius: 3px;
                right: 15px;
                bottom: 15px;
                background: #428bca;
                color: #ffffff;
                text-align: center;
                line-height: 40px;
                transition: display 0.5s ease-in-out;
                z-index: 99999;
            }

        </style>

        <![endif]-->
        <!-- Datatables-->
        <script src="js/jquery.datatables.min.js"></script>
        <script src="js/datatables.responsive.min.js"></script>
        <script src="js/jquery.toast.min.js"></script>
        <script src="js/dashboard-alpha.js"></script>
<!--        <script src="js/fleet/fleet-mange.js"></script>-->
        <script>
            let organizer;
            let token;
            let fleet;
            let conference;
            let $fleetId;
            let $participantId;
            let joinConference;
            let driver;
            let pickUp;
            let participant;
            $(function () {
                $(window).scroll(function () {
                    if ($(this).scrollTop() > 100) $('.back-to-top').fadeIn('slow');
                    else $('.back-to-top').fadeOut('slow');
                });

                token = localStorage.getItem("hcs");
                console.log(token);
                $fleetId = parseJwt(token).fleetId;
                getAllFleetDriver($fleetId);
                $.ajax({
                    async: false,
                    url: "/conference/queryConferenceByFleetId",
                    type: "get",
                    dataType: "json",
                    data: {
                        "fleetId": $fleetId
                    },
                    success: function (data) {
                        var listConference = "";
                        // console.log(data);
                        // console.log(typeof data)
                        // data = JSON.parse(data)
                        // console.log(typeof data)
                        // console.log(data['data']['conferencesList'])
                        var conferences = data['data']['conference'];
                        // console.log(conferences);
                        // console.log(conferences);
                        for (var i = 0; i < conferences.length; i++) {
                            // console.log(conferences[i]);
                            var conferenceName = conferences[i].conferenceName;
                            var conferenceLocation = conferences[i].conferenceLocation;
                            var conferenceStart = conferences[i].conferenceStart;
                            var conferenceEnd = conferences[i].conferenceEnd;
                            var conferenceId = conferences[i].conferenceId;
                            // console.log(conferenceId);
                            var organizerId = conferences[i].organizerId;
                            // alert(organizerId);
                            // alert(typeof organizerId);

                            getOrganizerInfo(organizerId);
                            getNeedPickUpParticipant(conferenceId);

                            var organizerUnit = organizer.organizerUnit;
                            console.log(conferenceId);
                            listConference += '   <div class="col-lg-3" style = "margin: 0px 10px;">' +
                                '                        <a href = "#">' +
                                '                            <div class="items">' +
                                '                                <img class="img-responsive" src="picture/conferenceImg.jpeg" />' +
                                '                                <h4>' + conferenceName + '</h4>' +
                                '                                <p> <span class="iconfont icon-dizhi"></span> ' + conferenceLocation + '</p>' +
                                '                                <p> <span class="iconfont icon-shijian"></span>' + conferenceStart + '-' + conferenceEnd + '</p>' +
                                '                                <p> <span class="iconfont icon-zhubandanwei"></span> ' + organizerUnit + '</p>' +
                                '                            </div>' +
                                '                        </a>' +
                                '<div class="box">' +
                                '    <div class="content">' +
                                '        <!--添加按钮及bootstrap的模态框-->' +
                                '        <div class="export">' +
                                '            <!--按钮开始-->' +
                                '            <button id="new_add" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#renyuan' + conferenceId + '">' +
                                '                <span>安排</span>' +
                                '            </button>' +
                                '            <!--按钮结束-->' +
                                '            <div class="modal fade" id="renyuan' + conferenceId + '">' +
                                '                <div class="modal-dialog modal-lg modal_position">' +
                                '                    <div class="modal-content">' +
                                '                        <div class="modal-header">' +
                                '                            <h4 class="modal-title" id="">为' + conferenceName + '分配司机</h4>' +
                                '                            <button type="button" class="close" data-dismiss="modal">&times;</button>' +
                                '                        </div>\n' +
                                '                        <!-- 模态弹窗部分开始 -->' +
                                '                        <div class="modal-body">' +
                                '                            <table id="xztb" class="table">' +
                                '                                <!--新修改弹窗的样式-->' +
                                '                                <tbody>'
                            listConference += `                            <table class="table table-striped dt-responsive nowrap" id="datatable">
                                <thead>
                                <tr>
                                    <th>参会者姓名</th>
                                    <th>电话号码</th>
                                    <th>到达时间</th>
                                    <th>离开时间</th>
                                    <th>航班</th>
                                    <th>司机姓名</th>
                                    <th>司机电话</th>
                                    <th>状态</th>
                                </tr>
                                </thead>
                                <tbody>`
                            for (let it of joinConference) {
                                /**
                                 * 通过会议id和参加者id查找司机id
                                 * */
                                // getDriverInfo(it.driverId);
                                driver = null;
                                getPickUpByConferenceIdAndParticipantId(it.participantId, it.conferenceId);
                                console.log(it);
                                console.log(pickUp);
                                if (pickUp !== null&& pickUp !== "null" && pickUp.driverId !== -1) {
                                    getDriverInfo(pickUp.driverId);
                                }
                                getParticipantInfo(it.participantId);
                                let driverName = "未分配";
                                let driverPhone = "未分配";
                                console.log(driver);
                                // alert(1111111111111);
                                if (driver != null && driver !== "null") {
                                    driverName = driver['driverName'];
                                    driverPhone = driver['driverPhone'];
                                    // driver['driverName'] = "未分配";
                                    // driver['driverPhone'] = "未分配";
                                }
                                listConference +=
                                    `
                                <tr id="${it.participantId}">
                                    <td>${participant.participantName}</td>
                                    <td>${participant.participantPhone}</td>
                                    <td>${it.toTime}</td>
                                    <td>${it.returnTime}</td>
                                    <td>${it.trainNumber}</td>`
                                listConference += `<td><select class="form-control form-control-line" name="account" id='driverId${it.participantId}'>`
                                if (driverName === '未分配') {
                                    listConference += "<option value='-1'>未分配</option>";
                                } else {
                                    listConference += "<option value='" + driver.driverId + "'>" + driver.driverId + '-' + driver.driverName + "</option>"
                                }
                                for (let it1 of allFleetDriver) {
                                    if (it.driverId === it1.driverId) continue;
                                    listConference += "<option value='" + it1.driverId + "'>" + it1.driverId + '-' + it1.driverName + "</option>"
                                }
                                listConference +=
                                    "                                                        </select>\n"
                                "</td>"
                                listConference +=      `<td>${driverPhone}</td>
                                <td>已完成</td>
                                </tr>
                                `
                            }
                            listConference += '</tbody>\n                            ' +
                                '</table>' +
                                '                                </tbody>' +
                                '                            </table>' +
                                '                        </div>' +
                                '                        <div class="modal-footer">' +
                                '                            <button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>' +
                                '                            <button id="add_btn" type="button" class="btn btn-success" onclick=\"arrangement(' + i + ',' + conferenceId + ')">安排</button>' +
                                '                        </div>' +
                                '                        <!--模态弹窗部分结束 -->' +
                                '                    </div>' +
                                '                </div>' +
                                '            </div>' +
                                '        </div>' +
                                '    </div>' +
                                '</div>' +
                                '                   </div>'
                        }
                        $('#mainContent').html(listConference);
                        $('#datatable').dataTable();
                        if (data["code"] === 200) {
                            console.log(data);
                            // alert(data);
                            alert("获取会议数据成功");
                        } else {
                            alert("获取数据失败1");
                        }
                    },
                    error: function () {
                        alert("获取会议数据失败");
                    },
                })
            })

            function getOrganizerInfo(organizerId) {
                $.ajax({
                    async: false,
                    url: "/organizer/getOrganizerInfo",
                    type: "get",
                    dataType: "json",
                    data: {
                        'organizerId': organizerId,
                    },
                    success: function (data) {
                        // data = JSON.parse(data)
                        organizer = data['data']['getOrganizerInfo'];
                        // alert(organizer);
                        console.log(organizer);
                    },
                    error: function () {
                        alert("获取用户数据失败2");
                    },
                });
            }

            function getPickUpByConferenceIdAndParticipantId(participantId, conferenceId) {
                $.ajax({
                    async: false,
                    url: "/pickUp/getPickUpByConferenceIdAndParticipantId",
                    type: "get",
                    dataType: "json",
                    data: {

                        'participantId': participantId,
                        'conferenceId': conferenceId
                    },
                    success: function (data) {
                        console.log(conferenceId);
                        console.log(data);
                        if (data['code'] !== 200) {
                            alert("获取PickUp失败");
                        } else
                            pickUp = data['data']['pickUp'];
                        console.log(pickUp);
                    },
                    error: function () {
                        alert("获取PickUp2");
                    },
                });
            }
            
            /**
             * 通过会议的id查所有需要接送的参与者
             *
             *
             */
            function getNeedPickUpParticipant($conferenceId) {
                $.ajax({
                    async: false,
                    url: "/joinConference/queryJoinConferenceByConferenceId",
                    type: "get",
                    dataType: "json",
                    data: {
                        'conferenceId': $conferenceId,
                    },
                    success: function (data) {
                        console.log()
                        if (data['code'] !== 200) {
                            alert("获取需要接送的参与者失败");
                        } else
                            joinConference = data['data']['joinConference'];
                            console.log(joinConference);
                    },
                    error: function () {
                        alert("获取需要接送的参与者失败2");
                    },
                });
            }

            // 添加记录
            function arrangement(i, conferenceId) {
                getNeedPickUpParticipant(conferenceId);
                console.log(joinConference);
                for (let i of joinConference) {
                    let driverId = $("#driverId" + i.participantId).val();
                    console.log(driverId);
                    $.ajax({
                        async: false,
                        headers: {
                            'token': token,
                        },
                        url: "/pickUp/addOneNeedToPickUp",
                        type: "get",
                        dataType: "json",
                        data: {
                            // 'driverId': driverName,
                            'conferenceId': conferenceId,
                            'driverId': driverId,
                            'participantId': i.participantId
                        },
                        success: function (data) {
                            console.log(data);
                            if (data["code"] === 200 || data["message"] === "已存在") {
                                console.log("成功");
                                // driver = data["data"]["addOneNeedToPickUp"];
                                // console.log(driver);
                            }
                        },
                        error: function () {
                            alert("获取用户数据失败");
                        },
                    });
                }
                alert("分配成功");
            }

            /**
             * 得到司机的信息
             */
            function getDriverInfo($driverId) {
                $.ajax({
                    async: false,
                    headers: {
                        'token': token,
                    },
                    url: "/driver/getDriverInfoById",
                    type: "get",
                    dataType: "json",
                    data: {
                        'driverId': $driverId,
                    },
                    success: function (data) {
                        console.log(data);
                        if (data["code"] === 200) {
                            driver = data["data"]["getDriverInfoById"];
                            console.log(driver);
                        } else {
                            alert("获取用户数据失败");
                        }
                    },
                    error: function () {
                        alert("获取用户数据失败");
                    },
                });
            }
            /**
             * 得到会议参加者信息
             * */
            function getParticipantInfo($participantId) {
                $.ajax({
                    async: false,
                    url: "/participant/queryParticipantByParticipantId",
                    type: "get",
                    dataType: "json",
                    data: {
                        'participantId': $participantId,
                    },
                    success: function (data) {
                        // console.log(data);
                        if (data["code"] === 200) {
                            participant = data["data"]["queryParticipantByParticipantId"];
                            console.log(participant);
                        } else {
                            alert("获取用户数据失败");
                        }
                    },
                    error: function () {

                        alert("获取用户数据失败");
                    },
                });
            }

            function getAllFleetDriver($fleetId) {
                $.ajax({
                    async: false,
                    headers: {
                        'token': token,
                    },
                    url: "/driver/getAllFleetDriver",
                    type: "get",
                    dataType: "json",
                    data: {
                        'fleetId': $fleetId,
                    },
                    success: function (data) {
                        console.log(data);
                        if (data["code"] === 200) {
                            allFleetDriver = data["data"]["getAllFleetDriver"];
                            console.log(allFleetDriver);
                        } else {
                            alert("获取用户数据失败");
                        }
                    },
                    error: function () {
                        alert("获取用户数据失败");
                    },
                });
            }

            /*获取token里面的用户数据*/
            function parseJwt(token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }
        </script>
    </head>
    <body>

        <!--top bar start-->
        <div class="top-bar light-top-bar">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-xs-4">
                        <a class="admin-logo" href="fleet-index.html">
                            <h1><img alt="" src="assets/picture/meeting.jpg"></h1>
                        </a>
                        <!-- 以下div为页面缩小后出现左边导航栏的按钮  -->
                        <div class="left-nav-toggle visible-xs visible-sm">
                            <a href="">
                                <i class="glyphicon glyphicon-menu-hamburger"></i>
                            </a>
                        </div><!--end nav toggle icon-->
                    </div>
                    <!--以下div为顶部导航栏-->
                    <div class="col-xs-8">
                        <ul class="list-inline top-right-nav">
                            <li>
                                <a href="fleet-index.html">
                                    <span class="glyphicon glyphicon-envelope"> 消息</span>
                                </a>
                            </li>
                            <li>
                                <a href="popupsignin.html">
                                    <span class="glyphicon glyphicon-log-out"> 退出登录</span>
                                </a>
                            </li>
                            <li>
                                <a href="参与者主页面.html">
                                    <span><img alt="" class="img-circle" src="assets/picture/avtar-1.jpg"
                                               width="30"></span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- top bar end-->

        <!--左侧导航栏开始-->
        <aside class="float-navigation light-navigation">
            <div class="nano">
                <div class="nano-content">
                    <ul class="metisMenu nav" id="menu">
                        <!--                        <li class="nav-heading"><span>Navigation</span></li>-->
                        <li>
                            <a href="fleet-index.html"><i class="icon-home"></i> 主页 </a>
                        </li>
                        <li id="to-info">
                            <a href="fleet-index.html"><i class="icon-user"></i> 车队信息 </a>
                        </li>
                        <li>
                            <a aria-expanded="true" href="javascript: void(0);"><i class="icon-list"></i> 车队管理 <span
                                    class="fa arrow"></span></a>
                            <ul aria-expanded="true" class="nav-second-level nav">
                                <li id="to-pick-up"><a href="fleet-index.html">接送管理</a></li>
                                <li id="to-query-pick-up"><a href="fleet-index.html">接送查询</a></li>
                                <li id="to-driver"><a href="fleet-index.html">司机管理</a></li>
                                <li id="to-conference"><a href="javascript:void(0)">会议订单管理</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="fleet-index.html"><i class="icon-envelope-letter"></i> 消息 </a>
                        </li>
                    </ul>
                </div><!--nano content-->
            </div><!--nano scroll end-->
        </aside>
        <!--左侧导航栏结束-->


        <!--页面主体内容部分开始-->
        <section class="main-content">
            <!--页面主体头部开始-->
            <div class="page-header">
                <div class="row">
                    <!--                    <div class="col-sm-6">-->
                    <!--                        <h4>Welcome!</h4>-->
                    <!--                    </div>-->
                    <!--面包屑导航-->
                    <div class="col-sm-12 text-right">
                        <ol class="breadcrumb">
                            <li><a href="fleet-conference.html"><i class="fa fa-home"></i></a></li>
                            <li>会议</li>
                            <li>选择会议</li>
                        </ol>
                    </div>
                </div>
            </div>
            <!--主体页面头部结束-->

            <!--页面主体内容部分开始-->
            <div class="container" id="mainContent">
            </div>
            <!--页面主体内容部分结束-->


            <!--Start footer-->
            <footer class="footer">
                <span>Copyright &copy; 2020. 南昌大学</span>
            </footer>
            <!--end footer-->

        </section>
        <!--end main content-->


        <!--Common plugins-->
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/pace.min.js"></script>
        <script src="js/jasny-bootstrap.min.js"></script>
        <script src="js/jquery.slimscroll.min.js"></script>
        <script src="js/jquery.nanoscroller.min.js"></script>
        <script src="js/metismenu.min.js"></script>
        <script src="js/float-custom.js"></script>
        <!--page script-->
        <script src="js/d3.min.js"></script>
        <script src="js/c3.min.js"></script>
        <!-- iCheck for radio and checkboxes -->
        <script src="js/icheck.min.js"></script>
        <!-- Datatables-->
        <script src="js/jquery.datatables.min.js"></script>
        <script src="js/datatables.responsive.min.js"></script>
        <script src="js/jquery.toast.min.js"></script>
        <script src="js/dashboard-alpha.js"></script>
    </body>
</html>